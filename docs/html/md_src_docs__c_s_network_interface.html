<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CS-EX NetworkInterface: The CommandStation EX NetworkInterface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="dccex-stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Dccpplogov2.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CS-EX NetworkInterface
   &#160;<span id="projectnumber">0.9</span>
   </div>
   <div id="projectbrief">Ethernet and WiFi capabilities over TCP/UDP for CommandStation-EX</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_src_docs__c_s_network_interface.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The CommandStation EX <a class="el" href="class_network_interface.html" title="Main entry point used to instatiate the network interface(s).">NetworkInterface</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md1"></a>
Summary</h2>
<p>The CommandStation-EX <a class="el" href="class_network_interface.html" title="Main entry point used to instatiate the network interface(s).">NetworkInterface</a> provides Ethernet and/or WiFi capabilities to CommandStation-EX. It supports TCP as well as UDP for sending data containing CommandStationEX recognized protocols i.e. JMRI or WiThrottle. Those commands can be transfered either as raw text or over HTTP.</p>
<p>For more information about CommandStation-EX can be found on <a href="https://github.com/DCC-EX/CommandStation-EX">github</a> or on the <a href="https://dcc-ex.com/">dcc-ex</a> website</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Features</h2>
<h3><a class="anchor" id="autotoc_md3"></a>
Networking</h3>
<ul>
<li><b>Network types supported</b> : Ethernet and WiFi</li>
<li><b>Network protocol support</b> : TCP and UDP</li>
<li><b>Application <a class="el" href="class_transport.html">Transport</a> protcols</b> : Raw text and HTTP; HTTPS for the ESP only and MQTT are to be done;</li>
<li><b>Application Payload - CommandStation EX protocols</b>: JMRI format as well as WitHrottle</li>
</ul>
<h3><a class="anchor" id="autotoc_md4"></a>
WiFi</h3>
<h3><a class="anchor" id="autotoc_md5"></a>
Ethernet</h3>
<ul>
<li>Automatic detection of the EthernetShield capabilities and number of possible concurrent connections for TCP</li>
<li>UDP will have only one connection available as its a non-connected stateless protocol and all clients will use the same connection</li>
<li>Etheret and WiFi can be mixed if a EtherNet Shield and ESP are both connected to the MCU</li>
</ul>
<p>The interface also supports multiple connections on different ports for TCP and UDP. You can also mix Ethernet and Wifi ( my setup has actually both connected currently ) WiThrottle over UDP should also support multiple clients as i know the remote IP and ports to reply to to the contrary of TCP as a connected protocol but that i can't test yet</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Diagnostics</h3>
<h3><a class="anchor" id="autotoc_md7"></a>
Dependencies</h3>
<ul>
<li>WiFi The WiFi connection makes use of the WiFiEspAT library from Juraj Andr√°ssy which can be found here: <a href="https://github.com/jandrassy/WiFiEspAT">github</a>. This library requires that the ESP, providing the WiFi hardware, supports an AT commandset version 1.7 or 2.1 as of today. All different ESP modules should be supported. Unfortunatley most ESP modules shipped today come with an older AT commandset installed by default. Therfore flashing your ESP may be required. Plans exist to build our own ESP WiFi AT library also supporting older AT commandsets. This library is available from the PIO library manager as well as from the Arduino IDE library manager. Please refer to the platformio.ini file on how to use the library. Using VSC together with PIO, instead of looking for the libary in PIO library manager, can just add the relevant file in your platformio.ini file and the compiler will find and download if required the library for you.</li>
</ul>
<p>Instructions for flashing your ESP can be found here: to be done</p>
<h3><a class="anchor" id="autotoc_md8"></a>
CommandStation EX Integration</h3>
<p>There are some code changes in the CommandStation EX code required which may be integrated into master eventually;</p>
<ul>
<li>Include files</li>
<li>RingBuffer</li>
</ul>
<h3><a class="anchor" id="autotoc_md9"></a>
Throttles</h3>
<h3><a class="anchor" id="autotoc_md10"></a>
Telnet</h3>
<h2><a class="anchor" id="autotoc_md11"></a>
Setup</h2>
<p>In <a class="el" href="_network_config_8h.html">NetworkConfig.h</a> : uncomment #define DCC_ENABLED; If that is commented out the <a class="el" href="class_network_interface.html" title="Main entry point used to instatiate the network interface(s).">NetworkInterface</a> runs standalone Once <a class="el" href="class_network_interface.html" title="Main entry point used to instatiate the network interface(s).">NetworkInterface</a> is part of the CommandStation EX master this step has been done already</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Attention Points</h2>
<ul>
<li>Memory Consumption: Every network interface instatiated will consume valuable memory/processing time needed also by other parts of the CommandStation. It is recommended to instantiate at most 2. If you don't have enough memory for Accessiries, Sensors, Turnouts etc. please look if one network interface would be sufficient.</li>
<li>For WiFi you need to reserve Serial 1 fo the connection to the ESP due to a limitation from the WiFiATEsp library. Otehrwise you could use SoftwareSerial (less recommended/feature has to be added)</li>
<li>UNO is not supported due to ressource limitation. An Arduino Mega is required.</li>
<li>Individual commands send shall not be longer than half of the MAX_ETH_BUFFER size in order to make sure that no command which spans two recieved packets is lost. The default settings should be sufficient for most use cases.</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Roadmap</h2>
<ul>
<li>Allow user defined application payload protocols</li>
<li>Integrate MQTT as an application transport protocol</li>
<li>Add SoftwareSerial to add the WiFi ESP</li>
<li>AP Access mode for WiFi</li>
<li>Reset persistent WiFi credentials</li>
</ul>
<h2><a class="anchor" id="autotoc_md14"></a>
Example .ino file for setting up the NetworkInterface</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;Arduino.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_d_i_a_g_8h.html">DIAG.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="free_memory_8h.html">freeMemory.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// (0) Include the header file</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_network_interface_8h.html">NetworkInterface.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// (1) Declare NetworkInterfaces; Two interfaces have been defined here</span></div>
<div class="line"><a class="code" href="class_network_interface.html">NetworkInterface</a> nwi1;</div>
<div class="line"><a class="code" href="class_network_interface.html">NetworkInterface</a> nwi2;</div>
<div class="line"><span class="comment">// (1) Declared NetworkInterfaces</span></div>
<div class="line"><span class="comment">// (2) Start NetworkInterface - HTTP callback</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> httpRequestHandler(<a class="code" href="struct_parsed_request.html">ParsedRequest</a> *req, Client* client) {</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nParsed Request:&quot;</span>));</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nMethod:         [%s]&quot;</span>), req-&gt;<a class="code" href="struct_parsed_request.html#af4e4790d8f338e78c3e6720c0397e490">method</a>);</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nURI:            [%s]&quot;</span>), req-&gt;<a class="code" href="struct_parsed_request.html#aa969118960d665d3a2f8aa27a41f0000">uri</a>);</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nHTTP version:   [%s]&quot;</span>), req-&gt;<a class="code" href="struct_parsed_request.html#afaa2d1cf6fbfdde289b6b3ac438f8340">version</a>);</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nParameter count:[%d]\n&quot;</span>), *req-&gt;<a class="code" href="struct_parsed_request.html#aaf34b6d32d4b9d20253c4bace7f9fc76">paramCount</a>);</div>
<div class="line">}</div>
<div class="line"><span class="comment">// (2) End NetworkInterface - HTTP callback</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup()</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// The main sketch has responsibilities during setup()</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Responsibility 1: Start the usb connection for diagnostics</span></div>
<div class="line">  <span class="comment">// This is normally Serial but uses SerialUSB on a SAMD processor</span></div>
<div class="line"> </div>
<div class="line">  Serial.begin(115200);</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;DCC++ EX NetworkInterface Standalone&quot;</span>));</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  <span class="comment">// (3) Start NetworkInterface - The original WifiInterface is still there but disabled</span></div>
<div class="line"> </div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nFree RAM before network init: [%d]\n&quot;</span>),<a class="code" href="free_memory_8cpp.html#a8d862dc01c44bfabc8d952bb77f8da89">freeMemory</a>());</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nNetwork Setup In Progress ...\n\n&quot;</span>));</div>
<div class="line">  </div>
<div class="line">  nwi1.<a class="code" href="class_network_interface.html#a8f05744c8bc994934df83686131bbc63">setup</a>(<a class="code" href="_network_interface_8h.html#a59eb013c6734195b94b275310e167df1a8f0fce6ed9d0370f45ef72a7b469937c">ETHERNET</a>, <a class="code" href="_network_interface_8h.html#af6adf0e71a06d4619216ff5e60479530aa040cd7feeb588104634cdadf35abf1c">TCP</a>, 8888);               <span class="comment">// ETHERNET/TCP on Port 8888</span></div>
<div class="line">  nwi1.<a class="code" href="class_network_interface.html#ac131f1227aa4e746238686378e9ddff4">setHttpCallback</a>(httpRequestHandler);      <span class="comment">// HTTP callback</span></div>
<div class="line"> </div>
<div class="line">  nwi2.<a class="code" href="class_network_interface.html#a8f05744c8bc994934df83686131bbc63">setup</a>(<a class="code" href="_network_interface_8h.html#a59eb013c6734195b94b275310e167df1a13e02909006158bf407b1093191dcf5b">WIFI</a>, <a class="code" href="_network_interface_8h.html#af6adf0e71a06d4619216ff5e60479530aa040cd7feeb588104634cdadf35abf1c">TCP</a>);                         <span class="comment">// WIFI/TCP on Port 2560</span></div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nNetwork Setup done ...\n&quot;</span>));</div>
<div class="line">  <a class="code" href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a>(F(<span class="stringliteral">&quot;\nFree RAM after network init: [%d]\n&quot;</span>),<a class="code" href="free_memory_8cpp.html#a8d862dc01c44bfabc8d952bb77f8da89">freeMemory</a>());</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// (2) End starting NetworkInterface</span></div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop()</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="comment">// (3) Start Loop NetworkInterface </span></div>
<div class="line"><a class="code" href="class_network_interface.html#a16289c91bcd5e48a00ad6fe5e8f0a2ad">NetworkInterface::loop</a>();</div>
<div class="line"><span class="comment">// (3) End Loop NetworkInterface</span></div>
<div class="line">  </div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aclass_network_interface_html_a16289c91bcd5e48a00ad6fe5e8f0a2ad"><div class="ttname"><a href="class_network_interface.html#a16289c91bcd5e48a00ad6fe5e8f0a2ad">NetworkInterface::loop</a></div><div class="ttdeci">static void loop()</div><div class="ttdef"><b>Definition:</b> NetworkInterface.cpp:166</div></div>
<div class="ttc" id="a_network_interface_8h_html_a59eb013c6734195b94b275310e167df1a13e02909006158bf407b1093191dcf5b"><div class="ttname"><a href="_network_interface_8h.html#a59eb013c6734195b94b275310e167df1a13e02909006158bf407b1093191dcf5b">WIFI</a></div><div class="ttdeci">@ WIFI</div><div class="ttdef"><b>Definition:</b> NetworkInterface.h:35</div></div>
<div class="ttc" id="a_d_i_a_g_8h_html_ad2390c07b2f83f490ae971a3fdc0c18b"><div class="ttname"><a href="_d_i_a_g_8h.html#ad2390c07b2f83f490ae971a3fdc0c18b">DIAG</a></div><div class="ttdeci">#define DIAG</div><div class="ttdef"><b>Definition:</b> DIAG.h:22</div></div>
<div class="ttc" id="aclass_network_interface_html_ac131f1227aa4e746238686378e9ddff4"><div class="ttname"><a href="class_network_interface.html#ac131f1227aa4e746238686378e9ddff4">NetworkInterface::setHttpCallback</a></div><div class="ttdeci">void setHttpCallback(HttpCallback callback)</div><div class="ttdoc">used for setting the user provided callback function for HTTP request handling</div><div class="ttdef"><b>Definition:</b> NetworkInterface.cpp:173</div></div>
<div class="ttc" id="a_network_interface_8h_html_a59eb013c6734195b94b275310e167df1a8f0fce6ed9d0370f45ef72a7b469937c"><div class="ttname"><a href="_network_interface_8h.html#a59eb013c6734195b94b275310e167df1a8f0fce6ed9d0370f45ef72a7b469937c">ETHERNET</a></div><div class="ttdeci">@ ETHERNET</div><div class="ttdef"><b>Definition:</b> NetworkInterface.h:36</div></div>
<div class="ttc" id="afree_memory_8h_html"><div class="ttname"><a href="free_memory_8h.html">freeMemory.h</a></div></div>
<div class="ttc" id="afree_memory_8cpp_html_a8d862dc01c44bfabc8d952bb77f8da89"><div class="ttname"><a href="free_memory_8cpp.html#a8d862dc01c44bfabc8d952bb77f8da89">freeMemory</a></div><div class="ttdeci">int freeMemory()</div><div class="ttdef"><b>Definition:</b> freeMemory.cpp:33</div></div>
<div class="ttc" id="a_network_interface_8h_html_af6adf0e71a06d4619216ff5e60479530aa040cd7feeb588104634cdadf35abf1c"><div class="ttname"><a href="_network_interface_8h.html#af6adf0e71a06d4619216ff5e60479530aa040cd7feeb588104634cdadf35abf1c">TCP</a></div><div class="ttdeci">@ TCP</div><div class="ttdoc">TCP standard protocol for the network connection management.</div><div class="ttdef"><b>Definition:</b> NetworkInterface.h:29</div></div>
<div class="ttc" id="aclass_network_interface_html"><div class="ttname"><a href="class_network_interface.html">NetworkInterface</a></div><div class="ttdoc">Main entry point used to instatiate the network interface(s).</div><div class="ttdef"><b>Definition:</b> NetworkInterface.h:75</div></div>
<div class="ttc" id="astruct_parsed_request_html"><div class="ttname"><a href="struct_parsed_request.html">ParsedRequest</a></div><div class="ttdef"><b>Definition:</b> HttpRequest.h:54</div></div>
<div class="ttc" id="astruct_parsed_request_html_aaf34b6d32d4b9d20253c4bace7f9fc76"><div class="ttname"><a href="struct_parsed_request.html#aaf34b6d32d4b9d20253c4bace7f9fc76">ParsedRequest::paramCount</a></div><div class="ttdeci">uint8_t * paramCount</div><div class="ttdef"><b>Definition:</b> HttpRequest.h:58</div></div>
<div class="ttc" id="a_d_i_a_g_8h_html"><div class="ttname"><a href="_d_i_a_g_8h.html">DIAG.h</a></div></div>
<div class="ttc" id="astruct_parsed_request_html_aa969118960d665d3a2f8aa27a41f0000"><div class="ttname"><a href="struct_parsed_request.html#aa969118960d665d3a2f8aa27a41f0000">ParsedRequest::uri</a></div><div class="ttdeci">char * uri</div><div class="ttdef"><b>Definition:</b> HttpRequest.h:56</div></div>
<div class="ttc" id="astruct_parsed_request_html_afaa2d1cf6fbfdde289b6b3ac438f8340"><div class="ttname"><a href="struct_parsed_request.html#afaa2d1cf6fbfdde289b6b3ac438f8340">ParsedRequest::version</a></div><div class="ttdeci">char * version</div><div class="ttdef"><b>Definition:</b> HttpRequest.h:57</div></div>
<div class="ttc" id="aclass_network_interface_html_a8f05744c8bc994934df83686131bbc63"><div class="ttname"><a href="class_network_interface.html#a8f05744c8bc994934df83686131bbc63">NetworkInterface::setup</a></div><div class="ttdeci">void setup(transportType t, protocolType p, uint16_t port)</div><div class="ttdoc">Used for specific port nummber; default is 2560.</div><div class="ttdef"><b>Definition:</b> NetworkInterface.cpp:87</div></div>
<div class="ttc" id="a_network_interface_8h_html"><div class="ttname"><a href="_network_interface_8h.html">NetworkInterface.h</a></div></div>
<div class="ttc" id="astruct_parsed_request_html_af4e4790d8f338e78c3e6720c0397e490"><div class="ttname"><a href="struct_parsed_request.html#af4e4790d8f338e78c3e6720c0397e490">ParsedRequest::method</a></div><div class="ttdeci">char * method</div><div class="ttdef"><b>Definition:</b> HttpRequest.h:55</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
